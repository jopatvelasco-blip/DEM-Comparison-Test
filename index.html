<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated DEM-Comp maker</title>
    <!-- Montserrat Font and Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for exporting HTML to image -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #000000;
        }
        #report-container, #setup-form, #final-output {
            width: 100%;
            max-width: 7680px;
            height: auto;
            background-color: #000000;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .map-container-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            border: 5px solid #ffdd00;
        }
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f1f1d7;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .bg-legend-pink { background-color: #fe8081; }
        .bg-legend-peach { background-color: #ffbf81; }
        .bg-legend-gray { background-color: #d3d3d3; }
        .bg-legend-purple { background-color: #807ffe; }
        .bg-legend-green { background-color: #81ff81; }
        .gcp-icon { height: 1.5rem; width: 1.5rem; object-fit: contain; }
        .paste-bin {
            border: 2px dashed #4b5563;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            min-height: 50px;
            cursor: pointer;
            color: #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .paste-bin:focus, .paste-bin:hover {
            border-color: #ffdd00;
            color: #ffdd00;
            outline: none;
        }
            .annotation-rect {
  position: absolute;
  border: 6px dashed red;
  cursor: move;
  resize: both;
  overflow: auto;
}
    </style>
</head>
<body>

    <!-- Setup Form -->
    <div id="setup-form" class="max-w-2xl w-full bg-black rounded-xl p-6 sm:p-10 shadow-2xl text-white">
        <h2 class="text-3xl font-semibold text-[#ffdd00] mb-6 text-center">Setup Report Details</h2>
        <form id="report-details-form" class="space-y-4">
            <div>
                <label for="form-survey-a" class="block text-sm font-medium">Survey A</label>
                <input type="text" id="form-survey-a" placeholder="e.g., 2025_02_03 B" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00] p-2 transition-colors">
            </div>
            <div>
                <label for="form-survey-b" class="block text-sm font-medium">Survey B</label>
                <input type="text" id="form-survey-b" placeholder="e.g., Belmont 2025_01_16 B" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00] p-2 transition-colors">
            </div>
            <div>
                <label for="form-site-name" class="block text-sm font-medium">Site</label>
                <input type="text" id="form-site-name" value="Belmont" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00] p-2 transition-colors">
            </div>
            <div>
                <label for="form-qa-select" class="block text-sm font-medium">Quality Assurance (QA)</label>
                <select id="form-qa-select" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00] p-2 transition-colors">
                    <option value="strict">Strict</option> <option value="moderate">Moderate</option> <option value="lenient">Lenient</option>
                </select>
            </div>
            <div>
                <label for="form-units-select" class="block text-sm font-medium">Units</label>
                <select id="form-units-select" class="mt-1 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00] p-2 transition-colors">
                    <option value="ftus">ft(US)</option>
                    <option value="ft">ft</option>
                    <option value="meters">meters</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium">GCPs used <span class="font-normal text-gray-400">(Choose the applicable GCPs)</span></label>
                <div id="gcp-checkbox-group" class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="gcp1" name="gcp-option" type="checkbox" value="Control AeroPoint, good fix, used, known point" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp1" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/Vv9PXXDs/1.png" alt="AP, good" class="gcp-icon"><p>Control AeroPoint, good fix, used, known point</p></label></div>
                    <div class="flex items-center"><input id="gcp2" name="gcp-option" type="checkbox" value="Control AeroPoint, good fix, unused" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp2" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/bvSMQQvX/2.png" alt="AP, good, unused" class="gcp-icon"><p>Control AeroPoint, good fix, unused</p></label></div>
                    <div class="flex items-center"><input id="gcp3" name="gcp-option" type="checkbox" value="Control AeroPoint, bad fix, unused" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp3" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/kGJfh87g/8.png" alt="AP, bad" class="gcp-icon"><p>Control AeroPoint, bad fix, unused</p></label></div>
                    <div class="flex items-center"><input id="gcp4" name="gcp-option" type="checkbox" value="Control, used" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp4" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/5N9RPctS/3.png" alt="Control, used" class="gcp-icon"><p>Control, used</p></label></div>
                    <div class="flex items-center"><input id="gcp5" name="gcp-option" type="checkbox" value="Control, unused" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp5" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/tJpMQwNy/4.png" alt="Control, unused" class="gcp-icon"><p>Control, unused</p></label></div>
                    <div class="flex items-center"><input id="gcp6" name="gcp-option" type="checkbox" value="Checkpoint" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp6" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/JnwFKGys/5.png" alt="Checkpoint" class="gcp-icon"><p>Checkpoint</p></label></div>
                    <div class="flex items-center"><input id="gcp7" name="gcp-option" type="checkbox" value="Checkpoint AeroPoint, good fix" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp7" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/BvFY84h4/6.png" alt="Checkpoint, AP, good" class="gcp-icon"><p>Checkpoint AeroPoint, good fix</p></label></div>
                    <div class="flex items-center"><input id="gcp8" name="gcp-option" type="checkbox" value="Checkpoint AeroPoint, bad fix" class="h-4 w-4 rounded border-gray-500 bg-gray-700 text-[#ffdd00] focus:ring-[#ffdd00]"><label for="gcp8" class="ml-3 text-sm text-white flex items-center gap-1"><img src="https://i.postimg.cc/pTYsZkbS/7.png" alt="Checkpoint, AP, bad" class="gcp-icon"><p>Checkpoint AeroPoint, bad fix</p></label></div>
                </div>
            </div>
            <button id="process-screenshot-btn" type="button" class="w-full mt-4 px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Process from Screenshot</button>
            <button type="submit" class="w-full mt-4 px-4 py-2 bg-[#ffdd00] text-gray-900 font-medium rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ffdd00] transition-colors">Generate Report</button>
        </form>
    </div>

    <!-- Report Container (initially hidden) -->
    <div id="report-container" 
     class="flex flex-col space-y-4 items-start" 
     style="display:none;">
        <div class="order-1 md:order-1 flex flex-col justify-start p-8">
            <header class="mb-4 text-center">
                <h1 class="text-[45px] font-semibold text-[#ffdd00]">DEM Comparison</h1>
                <div class="flex items-center justify-center gap-2 font-semibold text-sm text-white flex-wrap">
                    <span id="display-survey-names" class="text-[20px] text-white"></span>
                </div>
            </header>
            <div class="space-y-1 text-sm mb-4 text-center">
                <div><strong class="text-[18px] text-[#ffdd00]">Site:</strong> <span id="display-site-name" class="text-[18px] text-white"></span></div>
                <div><strong class="text-[18px] text-[#ffdd00]">Quality Assurance (QA):</strong> <span id="display-qa-level" class="text-[18px] text-white"></span></div>
                <div><strong class="text-[18px] text-[#ffdd00]">Units:</strong> <span id="display-units" class="text-[18px] text-white"></span></div>
            </div>

            <div class="mb-4"><div id="color-legend" class="flex items-end justify-center flex-wrap w-full"></div>
           <div class="flex flex-col items-center space-y-2 mt-4">
            <div id="display-gcp-list" class="text-[18px]space-y-1 text-sm mb-4"></div>
            <div class="space-y-1 text-xs mb-4"><p id="legend-note" class="text-[15px] text-[#ffdd00] font-medium mt-2 text-center"></p>
            
            </div>
            <button id="back-btn" class="w-full mt-4 px-4 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700">Change Settings</button>
        </div>

        <div class="order-2 p-8">
  <div class="map-container-wrapper rounded-lg">
    <div id="map-container" class="map-container rounded-lg shadow-inner">
      <canvas id="drawing-canvas"></canvas>
    </div>
  </div>

  <!-- PNG icon below the rectangle map -->
  <img 
    src="https://i.postimg.cc/1R6jfmCQ/Untitled-design-3.png" 
    alt="Legend extra note" 
    class="mx-auto mt-4 h-60 w-auto"
  />

  <div class="mt-4 flex flex-col gap-2">
    <label for="map-input" class="block text-sm font-medium text-white">
      Paste Image URL or Paste from Clipboard
    </label>
    <div class="flex gap-2">
      <input type="text" id="map-input" placeholder="Paste image URL or Ctrl+V here"
        class="flex-grow p-2 block w-full rounded-md border-gray-700 bg-gray-800 text-white shadow-sm focus:ring-[#ffdd00] focus:border-[#ffdd00]">
      <input type="file" id="file-input" accept="image/*" style="display: none;">
      <button id="load-map-btn" class="px-4 py-2 bg-[#ffdd00] text-gray-900 font-medium rounded-md hover:bg-yellow-600">Load</button>
      <button id="clear-canvas-btn" class="px-4 py-2 bg-red-500 text-white font-medium rounded-md hover:bg-red-600">Clear</button>
    </div>
  </div>

  <button id="download-btn" class="w-full mt-4 px-4 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600">Download Report</button>
</div>


    <script>
        const setupForm = document.getElementById('setup-form');
        const reportContainer = document.getElementById('report-container');
        const reportDetailsForm = document.getElementById('report-details-form');
        const backBtn = document.getElementById('back-btn');
        const mapInput = document.getElementById('map-input');
        const loadMapBtn = document.getElementById('load-map-btn');
        const mapContainer = document.getElementById('map-container');
        const colorLegend = document.getElementById('color-legend');
        const legendNote = document.getElementById('legend-note');
        const displaySurveyNames = document.getElementById('display-survey-names');
        const displaySiteName = document.getElementById('display-site-name');
        const displayQaLevel = document.getElementById('display-qa-level');
        const displayUnits = document.getElementById('display-units');
        const displayGcpList = document.getElementById('display-gcp-list');
        const downloadBtn = document.getElementById('download-btn');
        const gcpCheckboxes = document.querySelectorAll('input[name="gcp-option"]');
        const processScreenshotBtn = document.getElementById('process-screenshot-btn');
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        let isDrawing = false;
        let startX, startY;

        const legends = { 
        
        ftus: { 
        strict: [
            {r:'-3.3ft (US)',c:'bg-legend-pink'},
            {r:'-0.7ft (US)',c:'bg-legend-peach'},
            {r:'-0.3ft (US)',c:'bg-legend-gray'},
            {r:'0.0ft (US)',c:'bg-legend-gray'},
            {r:'0.3ft (US)',c:'bg-legend-gray'},
            {r:'0.7ft (US)',c:'bg-legend-purple'},
            {r:'3.3ft (US)',c:'bg-legend-green'}], 
        moderate: [
            {r:'-6.6ft (US)',c:'bg-legend-pink'},
            {r:'-1.3ft (US)',c:'bg-legend-peach'},
            {r:'-0.7ft (US)',c:'bg-legend-gray'},
            {r:'0.0ft (US)',c:'bg-legend-gray'},
            {r:'0.7ft (US)',c:'bg-legend-gray'},
            {r:'1.3ft (US)',c:'bg-legend-purple'},
            {r:'6.6ft (US)',c:'bg-legend-green'}], 
        lenient: [
            {r:'-13.1ft (US)',c:'bg-legend-pink'},
            {r:'-2.6ft (US)',c:'bg-legend-peach'},
            {r:'-1.3ft (US)',c:'bg-legend-gray'},
            {r:'0.0ft (US)',c:'bg-legend-gray'},
            {r:'1.3ft (US)',c:'bg-legend-gray'},
            {r:'2.6ft (US)',c:'bg-legend-purple'},
            {r:'13.1ft (US)',c:'bg-legend-green'}] 
            }, 
        ft: { 
        strict: [
            {r:'-3.3ft',c:'bg-legend-pink'},
            {r:'-0.7ft',c:'bg-legend-peach'},
            {r:'-0.3ft',c:'bg-legend-gray'},
            {r:'0.0ft',c:'bg-legend-gray'},
            {r:'0.3ft',c:'bg-legend-gray'},
            {r:'0.7ft',c:'bg-legend-purple'},
            {r:'3.3ft',c:'bg-legend-green'}
        ],
        moderate: [
            {r:'-6.6ft',c:'bg-legend-pink'},
            {r:'-1.3ft',c:'bg-legend-peach'},
            {r:'-0.7ft',c:'bg-legend-gray'},
            {r:'0.0ft',c:'bg-legend-gray'},
            {r:'0.7ft',c:'bg-legend-gray'},
            {r:'1.3ft',c:'bg-legend-purple'},
            {r:'6.6ft',c:'bg-legend-green'}
        ],
        lenient: [
            {r:'-13.1ft',c:'bg-legend-pink'},
            {r:'-2.6ft',c:'bg-legend-peach'},
            {r:'-1.3ft',c:'bg-legend-gray'},
            {r:'0.0ft',c:'bg-legend-gray'},
            {r:'1.3ft',c:'bg-legend-gray'},
            {r:'2.6ft',c:'bg-legend-purple'},
            {r:'13.1ft',c:'bg-legend-green'}
        ]
            },
        meters: { 
        strict: [
            {r:'-1.0m',c:'bg-legend-pink'},
            {r:'-0.2m',c:'bg-legend-peach'},
            {r:'-0.1m',c:'bg-legend-gray'},
            {r:'0.0m',c:'bg-legend-gray'},
            {r:'0.1m',c:'bg-legend-gray'},
            {r:'0.2m',c:'bg-legend-purple'},
            {r:'1.0m',c:'bg-legend-green'}], 
        moderate: [
            {r:'-2.0m',c:'bg-legend-pink'},
            {r:'-0.4m',c:'bg-legend-peach'},
            {r:'-0.2m',c:'bg-legend-gray'},
            {r:'0.0m',c:'bg-legend-gray'},
            {r:'0.2m',c:'bg-legend-gray'},
            {r:'0.4m',c:'bg-legend-purple'},
            {r:'2.0m',c:'bg-legend-green'}], 
        lenient: [
            {r:'-4.0m',c:'bg-legend-pink'},
            {r:'-0.8m',c:'bg-legend-peach'},
            {r:'-0.4m',c:'bg-legend-gray'},
            {r:'0.0m',c:'bg-legend-gray'},
            {r:'0.4m',c:'bg-legend-gray'},
            {r:'0.8m',c:'bg-legend-purple'},
            {r:'4.0m',c:'bg-legend-green'}] } };
        const notes = { ft: { strict: "Color means more than 100mm | 0.33' of change", moderate: "Color means more than 200mm | 0.66' of change", lenient: "Color means more than 400mm | 1.31' of change" },
                        ftus: { strict: "Color means more than 100mm | 0.33' of change", moderate: "Color means more than 200mm | 0.66' of change", lenient: "Color means more than 400mm | 1.31' of change" }, 
                        meters: { strict: "Color means more than 100mm | 0.33' of change", moderate: "Color means more than 200mm | 0.66' of change", lenient: "Color means more than 400mm | 1.31' of change" } };
        const gcps_images = {
            "Control AeroPoint, good fix, used, known point": "https://i.postimg.cc/Vv9PXXDs/1.png", "Control AeroPoint, good fix, unused": "https://i.postimg.cc/bvSMQQvX/2.png",
            "Control AeroPoint, bad fix, unused": "https://i.postimg.cc/kGJfh87g/8.png", "Control, used": "https://i.postimg.cc/5N9RPctS/3.png",
            "Control, unused": "https://i.postimg.cc/tJpMQwNy/4.png", "Checkpoint": "https://i.postimg.cc/JnwFKGys/5.png",
            "Checkpoint AeroPoint, good fix": "https://i.postimg.cc/BvFY84h4/6.png", "Checkpoint AeroPoint, bad fix": "https://i.postimg.cc/pTYsZkbS/7.png"
        };

        gcpCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (document.querySelectorAll('input[name="gcp-option"]:checked').length > 8) checkbox.checked = false;
            });
        });

            const updateLegend = (qa, u) => {
            const legData = legends[u][qa];
            colorLegend.innerHTML = '';

            // container for legend
            const legendWrapper = document.createElement('div');
            legendWrapper.className = 'flex flex-col items-center';

            // row of squares (no gaps between them)
            const legendRow = document.createElement('div');
            legendRow.className = 'flex justify-center';

            // row of labels
            const labelRow = document.createElement('div');
            labelRow.className = 'flex justify-center text-white text-xs mt-1';

            legData.forEach((item) => {
                // swatch square
                const swatch = document.createElement('div');
                swatch.className = `w-32 h-16 ${item.c}`;
                legendRow.appendChild(swatch);

                // label (same width as swatch so they line up)
                const label = document.createElement('div');
                label.className = 'w-32 text-[15px] text-center leading-tight';
                label.textContent = item.r;
                labelRow.appendChild(label);
            });

            legendWrapper.appendChild(legendRow);
            legendWrapper.appendChild(labelRow);
            colorLegend.appendChild(legendWrapper);

            legendNote.textContent = notes[u][qa];
            };


                const processImageWithVisionAPI = async (base64ImageData) => {
            const prompt = `
            Extract the following details from the image:
            - surveyA: The survey name shown in big bold text at the left above "Captured".
            - surveyB: The survey name shown in big bold text at the right above "Captured".
            - site: The full text in the bold heading at the very top.
            - qa: The Quality Assurance (QA) value.
            - units: The units used in measurements. To determine this, look at the text under "Expected Ground Control Accuracy error" or "Consistency with past surveys". 
                The unit may appear as:
                â€¢ "ft" (exactly that, no extra text)
                â€¢ "ft (US)" (with parentheses, include them exactly)
                â€¢ "meters"
                Do not simplify or shorten â€” return the unit string exactly as written in the image.
            Preserve it exactly as written in the image (do not normalize or simplify).

            Return only a JSON object with the keys: surveyA, surveyB, site, qa, and units.
            `;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/png", data: base64ImageData } }
                    ]
                }],
                generationConfig: { responseMimeType: "application/json" }
            };

            const apiKey = "AIzaSyAW_khLR-qN6tBcZwDUl-At_vDJt095kRE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
                
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("No content in API response.");

                let parsed = JSON.parse(jsonText);

                if (parsed.units) {
                    const u = parsed.units.trim();
                    if (u.includes("(US)")) {
                        parsed.units = "ftus";
                    } else if (u === "ft") {
                        parsed.units = "ft";
                    } else if (u.includes("meter") || u === "m") {
                        parsed.units = "meters";
                    }
                }



                return parsed;
            } catch (error) {
                console.error("Error processing image with Vision API:", error);
                return null;
            }
        };


        processScreenshotBtn.addEventListener('click', async () => {
            const tempDiv = document.createElement('div');
            document.body.appendChild(tempDiv);
            tempDiv.setAttribute('contenteditable', 'true');
            tempDiv.focus();

            const loadingMessage = document.createElement('div');
            loadingMessage.textContent = 'Please paste your screenshot (Ctrl+V) here...';
            loadingMessage.className = 'text-center text-white';
            setupForm.appendChild(loadingMessage);

            tempDiv.addEventListener('paste', async (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        loadingMessage.textContent = 'Processing screenshot...';
                        const file = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const base64Data = event.target.result.split(',')[1];
                            const reportData = await processImageWithVisionAPI(base64Data);
                            if (reportData) {
                                document.getElementById('form-survey-a').value = reportData.surveyA || '';
                                document.getElementById('form-survey-b').value = reportData.surveyB || '';
                                document.getElementById('form-site-name').value = reportData.site || '';
                                document.getElementById('form-qa-select').value = reportData.qa?.toLowerCase() || 'strict';
                                document.getElementById('form-units-select').value = reportData.units || 'meters';
                            }
                            loadingMessage.textContent = 'Done!';
                            setTimeout(() => {
                                document.body.removeChild(tempDiv);
                                setupForm.removeChild(loadingMessage);
                            }, 1000);
                        };
                        reader.readAsDataURL(file);
                        break;
                    }
                }
            });
        });
reportDetailsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const qa = document.getElementById('form-qa-select').value;
            const u = document.getElementById('form-units-select').value;
            
            // Get values from the form
            document.getElementById('display-survey-names').textContent = 
    `${document.getElementById('form-survey-a').value} vs ${document.getElementById('form-survey-b').value}`;

            document.getElementById('display-site-name').textContent = document.getElementById('form-site-name').value;
            document.getElementById('display-qa-level').textContent = qa.charAt(0).toUpperCase() + qa.slice(1);
            if (u === 'ftus') {
            document.getElementById('display-units').textContent = 'ft(US)';
            } else if (u === 'ft') {
            document.getElementById('display-units').textContent = 'ft';
            } else {
            document.getElementById('display-units').textContent = 'meters';
}

            
            // Populate legend and GCP list
            updateLegend(qa, u);
            const displayGcpList = document.getElementById('display-gcp-list');
            displayGcpList.innerHTML = '';
            document.querySelectorAll('input[name="gcp-option"]:checked').forEach(gcp => {
                const label = document.querySelector(`label[for="${gcp.id}"]`);
                const el = document.createElement('div'); el.className = 'flex items-center gap-1 text-sm text-white';
                const image_url = gcps_images[gcp.value];


                // Create the image safely with crossorigin
            const img = document.createElement("img");
            img.src = gcps_images[label.textContent];
            img.crossOrigin = "anonymous";   // ðŸ‘ˆ important
            img.alt = label.textContent;
            img.className = "h-7 w-7 object-contain align-middle translate-y-[6px]";



                // Create the label text
            const text = document.createElement("p");
            text.textContent = label.textContent;

            // Append them
            el.appendChild(img);
            el.appendChild(text);
            displayGcpList.appendChild(el);
            });
            setupForm.style.display = 'none'; reportContainer.style.display = 'grid';
        });

        backBtn.addEventListener('click', () => { reportContainer.style.display = 'none'; setupForm.style.display = 'block'; });

        const displayImage = (dataUrl) => {
            const mapContainer = document.getElementById('map-container');
            const mapContainerWrapper = document.querySelector('.map-container-wrapper');
            const img = new Image();

            img.onload = function() {
                const aspectRatio = this.width / this.height;
                mapContainerWrapper.style.paddingTop = `${(1 / aspectRatio) * 100}%`;
                
                mapContainer.style.backgroundImage = `url('${dataUrl}')`;
                mapContainer.textContent = '';
                mapContainer.classList.remove('flex', 'items-center', 'justify-center', 'text-center', 'text-red-500');
            };
            img.src = dataUrl;
            // --- Annotation Rectangles ---
let creatingRect = false;
let rect, startX, startY;

mapContainer.addEventListener("mousedown", (e) => {
  if (e.target !== mapContainer) return; // don't create on existing rects

  creatingRect = true;
  startX = e.offsetX;
  startY = e.offsetY;

  rect = document.createElement("div");
  rect.className = "annotation-rect";
  rect.style.left = `${startX}px`;
  rect.style.top = `${startY}px`;
  rect.style.width = "0px";
  rect.style.height = "0px";
  mapContainer.appendChild(rect);

  function onMouseMove(ev) {
    const currentX = ev.offsetX;
    const currentY = ev.offsetY;
    rect.style.width = `${Math.abs(currentX - startX)}px`;
    rect.style.height = `${Math.abs(currentY - startY)}px`;
    rect.style.left = `${Math.min(currentX, startX)}px`;
    rect.style.top = `${Math.min(currentY, startY)}px`;
  }

  function onMouseUp() {
    creatingRect = false;
    document.removeEventListener("mousemove", onMouseMove);
    document.removeEventListener("mouseup", onMouseUp);

    makeDraggable(rect);
  }

  document.addEventListener("mousemove", onMouseMove);
  document.addEventListener("mouseup", onMouseUp);
});

function makeDraggable(el) {
  let offsetX, offsetY, isDown = false;

  el.addEventListener("mousedown", (e) => {
    if (e.target !== el) return; // allow resize handles
    isDown = true;
    offsetX = e.offsetX;
    offsetY = e.offsetY;
    document.addEventListener("mousemove", mouseMove);
    document.addEventListener("mouseup", mouseUp);
  });

  function mouseMove(ev) {
    if (!isDown) return;
    const rect = el.parentNode.getBoundingClientRect();
    const x = ev.clientX - rect.left - offsetX;
    const y = ev.clientY - rect.top - offsetY;
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
  }

  function mouseUp() {
    isDown = false;
    document.removeEventListener("mousemove", mouseMove);
    document.removeEventListener("mouseup", mouseUp);
  }
}};

// Clear button functionality
clearCanvasBtn.addEventListener("click", () => {
    // Remove background image
    mapContainer.style.backgroundImage = "none";

    // Remove all annotation rectangles
    const rects = mapContainer.querySelectorAll(".annotation-rect");
    rects.forEach(r => r.remove());

    // Optional: reset aspect ratio
    document.querySelector('.map-container-wrapper').style.paddingTop = "56.25%";
});

        const fileInput = document.getElementById("file-input");

        loadMapBtn.addEventListener("click", () => {
         if (mapInput.value.trim()) {
        // Load by URL
        displayImage(mapInput.value.trim());
        } else {
        // Open file picker
        fileInput.click();
        }
        });

        fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (file) {
        const reader = new FileReader();
        reader.onload = (e) => displayImage(e.target.result);
        reader.readAsDataURL(file);
        }
        });

        // Still keep paste-to-input functionality
        mapInput.addEventListener("paste", (e) => {
        const items = (e.clipboardData || window.clipboardData).items;
        for (let i of items) {
        if (i.type.indexOf("image") !== -1) {
            const f = i.getAsFile();
            const r = new FileReader();
            r.onload = (e) => displayImage(e.target.result);
            r.readAsDataURL(f);
        }
        }
        });
        loadMapBtn.addEventListener('click', () => { if (mapInput.value.trim()) displayImage(mapInput.value.trim()); });
        mapInput.addEventListener('paste', e => {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let i of items) { if (i.type.indexOf('image') !== -1) { const f = i.getAsFile(); const r = new FileReader(); r.onload = e => displayImage(e.target.result); r.readAsDataURL(f); } }
        });
        
        downloadBtn.addEventListener('click', () => {
    const reportContainer = document.getElementById('report-container');

    // Temporarily hide the download button to prevent it from being in the screenshot
    downloadBtn.style.display = 'none';
    // Also hide the input field and load button, so they don't appear in the image
    const inputControls = document.querySelector('.mt-4.flex.flex-col.gap-2');
    inputControls.style.display = 'none';
    const backButton = document.getElementById('back-btn');
    backButton.style.display = 'none';
    
    // Temporarily replace input fields with static text for a clean screenshot
    const tempInputs = [];
    document.querySelectorAll('#report-container input[type="text"]').forEach(input => {
        const span = document.createElement('span');
        span.textContent = input.value;
        span.className = input.className;
        input.parentNode.replaceChild(span, input);
        tempInputs.push({ original: input, replacement: span });
    });
    // Temporarily replace dropdowns with static text
    const tempSelects = [];
    document.querySelectorAll('#report-container select').forEach(select => {
        const span = document.createElement('span');
        span.textContent = select.options[select.selectedIndex].text;
        span.className = 'text-white';
        select.parentNode.replaceChild(span, select);
        tempSelects.push({ original: select, replacement: span });
    });
    


    html2canvas(reportContainer, {
        backgroundColor: '#000000', // Ensure a black background for the final image
        scale: 2 ,// Increase scale for higher resolution
        useCORS: true
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'dem-comparison-report.png';
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Restore the buttons and input controls
        downloadBtn.style.display = 'block';
        inputControls.style.display = 'flex';
        backButton.style.display = 'block';
        
        // Restore the original input fields and dropdowns
        tempInputs.forEach(item => {
            item.replacement.parentNode.replaceChild(item.original, item.replacement);
        });
        tempSelects.forEach(item => {
            item.replacement.parentNode.replaceChild(item.original, item.replacement);
        });
    });
});
    </script>
</body>
</html>


